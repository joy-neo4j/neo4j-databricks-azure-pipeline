# Secrets Configuration
# Defines secret management strategy and fallback mechanisms

# Secret Sources (in order of precedence)
secret_sources:
  - type: environment_specific
    description: "Environment-specific GitHub secrets (e.g., PROD_AZURE_CREDENTIALS)"
    enabled: true
    priority: 1
  
  - type: repository
    description: "Repository-level GitHub secrets"
    enabled: true
    priority: 2
  
  - type: azure_keyvault
    description: "Azure Key Vault (for production)"
    enabled: true
    priority: 3
    config:
      vault_pattern: "kv-neo4j-{environment}"

# Required Secrets
required_secrets:
  azure:
    - name: AZURE_CREDENTIALS
      description: "Azure service principal credentials (JSON)"
      type: json
      validation:
        required_fields: [clientId, clientSecret, subscriptionId, tenantId]
      environments: [dev, staging, prod]
      fallback: true
    
    - name: AZURE_SUBSCRIPTION_ID
      description: "Azure subscription ID"
      type: uuid
      environments: [dev, staging, prod]
      fallback: true
    
    - name: AZURE_TENANT_ID
      description: "Azure tenant ID"
      type: uuid
      environments: [dev, staging, prod]
      fallback: true
  
  databricks:
    - name: DATABRICKS_HOST
      description: "Databricks workspace URL"
      type: url
      validation:
        pattern: "^https://.*\\.azuredatabricks\\.net$"
      environments: [dev, staging, prod]
      fallback: false
    
    - name: DATABRICKS_TOKEN
      description: "Databricks personal access token"
      type: string
      validation:
        min_length: 30
        pattern: "^dapi.*"
      environments: [dev, staging, prod]
      fallback: true
      rotation_days: 90
    
    - name: DATABRICKS_ACCOUNT_ID
      description: "Databricks account ID for workspace creation"
      type: uuid
      environments: [dev, staging, prod]
      fallback: true
  
  neo4j:
    - name: AURA_CLIENT_ID
      description: "Neo4j Aura API client ID"
      type: uuid
      environments: [dev, staging, prod]
      fallback: true
    
    - name: AURA_CLIENT_SECRET
      description: "Neo4j Aura API client secret"
      type: string
      validation:
        min_length: 20
      environments: [dev, staging, prod]
      fallback: true
      rotation_days: 90

# Optional Secrets
optional_secrets:
  notifications:
    - name: SLACK_WEBHOOK_URL
      description: "Slack webhook for notifications"
      type: url
      validation:
        pattern: "^https://hooks\\.slack\\.com/.*"
    
    - name: NOTIFICATION_EMAIL
      description: "Email for notifications"
      type: email
  
  monitoring:
    - name: DATADOG_API_KEY
      description: "Datadog API key for monitoring"
      type: string
    
    - name: PAGERDUTY_API_KEY
      description: "PagerDuty API key for alerting"
      type: string

# Fallback Strategy
fallback_strategy:
  enabled: true
  order:
    - "{ENVIRONMENT}_{SECRET_NAME}"  # e.g., PROD_AZURE_CREDENTIALS
    - "{SECRET_NAME}"                  # e.g., AZURE_CREDENTIALS
    - "keyvault://{environment}/{secret_name}"  # Azure Key Vault
  
  on_missing:
    action: fail
    message: "Required secret not found after checking all sources"

# Secret Rotation
rotation:
  enabled: true
  check_expiration: true
  warn_days_before: 14
  notification_channels:
    - slack
    - email

# Secret Validation
validation:
  enabled: true
  validate_on_workflow_start: true
  validate_format: true
  validate_connectivity: false  # Don't test actual connections in validation

# Security
security:
  mask_in_logs: true
  never_echo: true
  use_github_secrets: true
  encrypt_at_rest: true
  
# Audit
audit:
  log_secret_access: true
  log_secret_updates: true
  audit_log_path: /var/log/secrets-audit.log
