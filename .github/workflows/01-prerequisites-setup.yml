name: 01 - Prerequisites Setup

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: prereqs-${{ github.ref }}-dev
  cancel-in-progress: true

jobs:
  validate-credentials:
    name: Validate Azure and Neo4j Credentials
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      azure_valid: ${{ steps.azure-check.outputs.valid }}
      databricks_valid: ${{ steps.databricks-check.outputs.valid }}
      neo4j_valid: ${{ steps.neo4j-check.outputs.valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install databricks-cli requests pyyaml

      - name: Azure login (validate AZURE_CREDENTIALS)
        id: azure-login
        uses: azure/login@v2
        continue-on-error: true
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure validity output
        id: azure-check
        run: |
          if [ "${{ steps.azure-login.outcome }}" == "success" ]; then
            echo "✅ Azure credentials are valid"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Azure credentials are invalid or not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Databricks Token
        id: databricks-check
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          if [ -z "$DATABRICKS_HOST" ] || [ -z "$DATABRICKS_TOKEN" ]; then
            echo "❌ Databricks host or token not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Try Databricks CLI first
          if databricks workspace ls / > /dev/null 2>&1; then
            echo "✅ Databricks token is valid (verified via CLI)"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ CLI validation failed, trying REST API fallback"
            # Fallback to REST API
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $DATABRICKS_TOKEN" \
              "${DATABRICKS_HOST}/api/2.0/preview/scim/v2/Me")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "✅ Databricks token is valid (verified via REST API)"
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "❌ Databricks token validation failed (HTTP $HTTP_CODE)"
              echo "valid=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Setup Aura CLI config directory
        run: |
          # Create ephemeral config directory for Aura CLI
          mkdir -p /tmp/aura-config
          echo "XDG_CONFIG_HOME=/tmp/aura-config" >> $GITHUB_ENV
          echo "AURA_CONFIG_DIR=/tmp/aura-config" >> $GITHUB_ENV

      - name: Install Aura CLI
        run: |
          set -e
          # Download latest Aura CLI release for Linux x86_64
          LATEST_RELEASE=$(curl -sL https://api.github.com/repos/neo4j/aura-cli/releases/latest | jq -r '.tag_name')
          
          if [ -z "$LATEST_RELEASE" ] || [ "$LATEST_RELEASE" = "null" ]; then
            echo "❌ Failed to fetch latest Aura CLI release"
            exit 1
          fi
          
          echo "Installing Aura CLI version: $LATEST_RELEASE"
          
          DOWNLOAD_URL="https://github.com/neo4j/aura-cli/releases/download/${LATEST_RELEASE}/aura-cli_${LATEST_RELEASE}_Linux_x86_64.tar.gz"
          
          if ! curl -sL "$DOWNLOAD_URL" -o /tmp/aura-cli.tar.gz; then
            echo "❌ Failed to download Aura CLI from $DOWNLOAD_URL"
            exit 1
          fi
          
          # Extract and install
          if ! tar -xzf /tmp/aura-cli.tar.gz -C /tmp; then
            echo "❌ Failed to extract Aura CLI archive"
            exit 1
          fi
          
          if [ ! -f /tmp/aura-cli ]; then
            echo "❌ aura-cli binary not found in archive"
            exit 1
          fi
          
          mkdir -p $HOME/.local/bin
          mv /tmp/aura-cli $HOME/.local/bin/
          chmod +x $HOME/.local/bin/aura-cli
          
          # Add to PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Validate Neo4j Aura Credentials
        id: neo4j-check
        env:
          AURA_CLIENT_ID: ${{ secrets.AURA_CLIENT_ID }}
          AURA_CLIENT_SECRET: ${{ secrets.AURA_CLIENT_SECRET }}
        run: |
          if [ -z "$AURA_CLIENT_ID" ] || [ -z "$AURA_CLIENT_SECRET" ]; then
            echo "❌ Neo4j Aura credentials not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Configure credentials using Aura CLI
          if ! $HOME/.local/bin/aura-cli credential add --name ci \
            --client-id "$AURA_CLIENT_ID" \
            --client-secret "$AURA_CLIENT_SECRET" \
            --use; then
            echo "❌ Failed to configure Aura CLI credentials"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Validate by listing instances
          if $HOME/.local/bin/aura-cli instance list --output json > /dev/null 2>&1; then
            echo "✅ Neo4j Aura credentials are valid"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Neo4j Aura credentials validation failed"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Cleanup Aura CLI config
        if: always()
        run: |
          # Clean up ephemeral config directory
          rm -rf /tmp/aura-config
          rm -f /tmp/aura-cli.tar.gz

  validate-neo4j-connector:
    name: Validate Neo4j Spark Connector
    runs-on: ubuntu-latest
    needs: validate-credentials
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Neo4j Connector Version
        run: |
          echo "Validating Neo4j Spark Connector 5.3.0 for Spark 3.5"
          
          # Check if connector library exists in configs
          if [ -f "configs/neo4j-connector-config.yml" ]; then
            echo "✅ Neo4j connector configuration found"
          else
            echo "⚠️ Neo4j connector configuration not found - will be created"
          fi
          
          echo "Target Connector: neo4j-connector-apache-spark_2.12:5.3.0_for_spark_3.5"
          echo "Maven Repository: https://repo1.maven.org/maven2/"

      - name: Validate Connector Compatibility
        run: |
          cat > /tmp/connector-check.py << 'EOF'
          import requests
          import sys
          
          # Check if Neo4j connector exists in Maven Central
          connector_version = "5.3.0_for_spark_3.5"
          group_id = "org.neo4j"
          artifact_id = "neo4j-connector-apache-spark_2.12"
          
          maven_url = f"https://repo1.maven.org/maven2/org/neo4j/{artifact_id}/{connector_version}/"
          
          response = requests.get(maven_url)
          if response.status_code == 200:
              print(f"✅ Neo4j Connector {connector_version} is available in Maven Central")
              sys.exit(0)
          else:
              print(f"❌ Neo4j Connector {connector_version} not found in Maven Central")
              print(f"URL checked: {maven_url}")
              sys.exit(1)
          EOF
          
          python /tmp/connector-check.py

  validate-region-configuration:
    name: Validate UK South Region Configuration
    runs-on: ubuntu-latest
    needs: validate-credentials
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Azure UK South Region
        run: |
          echo "Validating UK South region configuration"
          
          # Check if terraform configs use UK South
          if grep -r "uksouth" terraform/; then
            echo "✅ UK South region configured in Terraform"
          else
            echo "⚠️ UK South region not found in Terraform configs"
          fi

      - name: Validate Neo4j UK Region
        run: |
          echo "Neo4j Aura UK South region: uksouth"
          echo "✅ UK region configured for data residency compliance"

  summary:
    name: Prerequisites Summary
    runs-on: ubuntu-latest
    needs: [validate-credentials, validate-neo4j-connector, validate-region-configuration]
    steps:
      - name: Prerequisites Summary
        run: |
          echo "=================================="
          echo "Prerequisites Validation Complete"
          echo "=================================="
          echo ""
          echo "✅ Azure Credentials: Valid"
          echo "✅ Databricks Token: Valid"
          echo "✅ Neo4j Aura Credentials: Valid"
          echo "✅ Neo4j Spark Connector: Compatible"
          echo "✅ UK South Region: Configured"
          echo ""
          echo "Ready to proceed with infrastructure deployment!"
