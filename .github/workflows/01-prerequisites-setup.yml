name: 01 - Prerequisites Setup

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: prereqs-${{ github.ref }}-dev
  cancel-in-progress: true

jobs:
  validate-credentials:
    name: Validate Azure and Neo4j Credentials
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      azure_valid: ${{ steps.azure-check.outputs.valid }}
      databricks_valid: ${{ steps.databricks-check.outputs.valid }}
      neo4j_valid: ${{ steps.neo4j-check.outputs.valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install azure-cli databricks-cli requests pyyaml

      - name: Prepare Aura CLI config (ephemeral)
        run: |
          mkdir -p "$RUNNER_TEMP/aura-config"
          echo "XDG_CONFIG_HOME=$RUNNER_TEMP/aura-config" >> "$GITHUB_ENV"

      - name: Download and install Aura CLI (latest Linux x86_64)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          OWNER="neo4j"
          REPO="aura-cli"
          ASSET_PATTERN="Linux_x86_64.tar.gz"

          # Fetch latest release metadata
          RELEASE_JSON=$(curl -sS -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/releases/latest")

          # Extract asset URL matching the pattern
          ASSET_URL=$(echo "$RELEASE_JSON" | jq -r \
            ".assets[] | select(.name | test(\"$ASSET_PATTERN\")) | .browser_download_url")

          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
            echo "❌ No asset matching pattern '$ASSET_PATTERN' found in latest release"
            exit 1
          fi

          echo "Downloading: $ASSET_URL"
          curl -L --fail --max-filesize 100M --max-time 300 -o aura-cli.tar.gz "$ASSET_URL"

          # Extract and install
          mkdir -p "$RUNNER_TEMP/aura-cli"
          tar -xzf aura-cli.tar.gz -C "$RUNNER_TEMP/aura-cli"
          BIN=$(find "$RUNNER_TEMP/aura-cli" -type f -name 'aura-cli' | head -n1)
          if [ -z "$BIN" ]; then
            echo "❌ aura-cli binary not found after extraction"
            find "$RUNNER_TEMP/aura-cli" -maxdepth 2 -type f -print || true
            exit 1
          fi
          chmod +x "$BIN"
          mkdir -p "$HOME/.local/bin"
          mv "$BIN" "$HOME/.local/bin/aura-cli"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          aura-cli --version

      - name: Configure Aura CLI
        env:
          AURA_CLIENT_ID: ${{ secrets.AURA_CLIENT_ID }}
          AURA_CLIENT_SECRET: ${{ secrets.AURA_CLIENT_SECRET }}
        run: |
          if [ -z "$AURA_CLIENT_ID" ] || [ -z "$AURA_CLIENT_SECRET" ]; then
            echo "❌ AURA_CLIENT_ID or AURA_CLIENT_SECRET not set"
            exit 1
          fi
          aura-cli credential add \
            --name "ci" \
            --client-id "$AURA_CLIENT_ID" \
            --client-secret "$AURA_CLIENT_SECRET"

      - name: Azure login (validate AZURE_CREDENTIALS)
        id: azure-login
        uses: azure/login@v2
        continue-on-error: true
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure validity output
        id: azure-check
        run: |
          if [ "${{ steps.azure-login.outcome }}" == "success" ]; then
            echo "✅ Azure credentials are valid"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Azure credentials are invalid or not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Databricks Token (CLI then REST)
        id: databricks-check
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          if [ -z "$DATABRICKS_HOST" ] || [ -z "$DATABRICKS_TOKEN" ]; then
            echo "❌ Databricks host or token not set"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          export DATABRICKS_CONFIG_FILE="$RUNNER_TEMP/databricks.ini"
          printf "[DEFAULT]\nhost=%s\ntoken=%s\n" "$DATABRICKS_HOST" "$DATABRICKS_TOKEN" > "$DATABRICKS_CONFIG_FILE"

          if databricks workspace ls / >/dev/null 2>&1; then
            echo "✅ Databricks token is valid (CLI)"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "CLI check failed; trying REST"
            CODE=$(curl -sS -m 20 -w "%{http_code}" -o /dev/null \
              -H "Authorization: Bearer $DATABRICKS_TOKEN" \
              "$DATABRICKS_HOST/api/2.0/preview/scim/v2/Me" 2>/dev/null || echo "000")
            if [ "$CODE" -eq 200 ]; then
              echo "✅ Databricks token is valid (REST)"
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "❌ Databricks token validation failed (HTTP $CODE)"
              echo "valid=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Validate Neo4j Aura Credentials (Aura CLI)
        id: neo4j-check
        run: |
          if aura-cli instance list --output json >/dev/null 2>&1; then
            echo "✅ Neo4j Aura credentials are valid (Aura CLI)"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Neo4j Aura CLI authentication failed"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # New step: List AuraDB tenants after successful validation
      - name: List AuraDB tenants
        if: ${{ steps.neo4j-check.outputs.valid == 'true' }}
        run: |
          aura-cli tenant list

      # New steps: Configure Databricks CLI for listing and list workspace
      - name: Configure Databricks CLI for listing
        if: ${{ steps.databricks-check.outputs.valid == 'true' }}
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          mkdir -p ~/.databricks
          printf "[DEFAULT]\nhost=%s\ntoken=%s\n" "$DATABRICKS_HOST" "$DATABRICKS_TOKEN" > ~/.databricks/config

      - name: List Databricks workspace objects
        if: ${{ steps.databricks-check.outputs.valid == 'true' }}
        run: |
          databricks workspace list /

      - name: Cleanup Aura CLI config
        if: always()
        run: |
          rm -rf "$XDG_CONFIG_HOME"

  validate-region-configuration:
    name: Validate UK South Region Configuration
    runs-on: ubuntu-latest
    needs: validate-credentials
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Azure UK South Region
        run: |
          echo "Validating UK South region configuration"
          
          # Check if terraform configs use UK South
          if grep -r "uksouth" terraform/; then
            echo "✅ UK South region configured in Terraform"
          else
            echo "⚠️ UK South region not found in Terraform configs"
          fi

      - name: Validate Neo4j UK Region
        run: |
          echo "Neo4j Aura UK South region: uksouth"
          echo "✅ UK region configured for data residency compliance"

  summary:
    name: Prerequisites Summary
    runs-on: ubuntu-latest
    needs: [validate-credentials, validate-region-configuration]
    steps:
      - name: Prerequisites Summary
        run: |
          echo "=================================="
          echo "Prerequisites Validation Complete"
          echo "=================================="
          echo ""
          echo "✅ Azure Credentials: Valid"
          echo "✅ Databricks Token: Valid"
          echo "✅ Neo4j Aura Credentials: Valid"
          echo "✅ UK South Region: Configured"
          echo ""
          echo "Ready to proceed with infrastructure deployment!"
