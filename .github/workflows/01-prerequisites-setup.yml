name: 01 - Prerequisites Setup

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: prereqs-${{ github.ref }}-dev
  cancel-in-progress: true

jobs:
  validate-credentials:
    name: Validate Azure and Neo4j Credentials
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      azure_valid: ${{ steps.azure-check.outputs.valid }}
      databricks_valid: ${{ steps.databricks-check.outputs.valid }}
      neo4j_valid: ${{ steps.neo4j-check.outputs.valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install azure-cli databricks-cli requests pyyaml

      - name: Azure login (validate AZURE_CREDENTIALS)
        id: azure-login
        uses: azure/login@v2
        continue-on-error: true
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure validity output
        id: azure-check
        run: |
          if [ "${{ steps.azure-login.outcome }}" == "success" ]; then
            echo "✅ Azure credentials are valid"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Azure credentials are invalid or not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Databricks Token
        id: databricks-check
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          if [ -z "$DATABRICKS_TOKEN" ]; then
            echo "❌ Databricks token not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Try to authenticate with Databricks CLI first
          databricks configure --token <<EOF
          $DATABRICKS_HOST
          $DATABRICKS_TOKEN
          EOF

          # Validate authentication using CLI
          if databricks workspace list --output json >/dev/null 2>&1; then
            echo "✅ Databricks token is valid (CLI authentication successful)"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Databricks CLI authentication failed, trying REST API..."
            
            # Fallback to REST API validation
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $DATABRICKS_TOKEN" \
              "${DATABRICKS_HOST}/api/2.0/clusters/list")
            
            if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 400 ]; then
              # 200 = success, 400 = no clusters but auth worked
              echo "✅ Databricks token is valid (REST API authentication successful)"
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "❌ Databricks token authentication failed (HTTP $RESPONSE)"
              echo "valid=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      # Prepare isolated config directory for Aura CLI
      - name: Prepare Aura CLI config
        run: |
          mkdir -p "$RUNNER_TEMP/aura-config"
          echo "XDG_CONFIG_HOME=$RUNNER_TEMP/aura-config" >> "$GITHUB_ENV"

      # Install Aura CLI via Go (no third-party actions)
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install Aura CLI
        run: |
          go install github.com/neo4j/aura-cli@latest
          echo "$HOME/go/bin" >> "$GITHUB_PATH"

      - name: Verify Aura CLI installation
        run: |
          aura-cli --version

      # Configure and validate Aura
      - name: Configure Aura CLI
        env:
          AURA_CLIENT_ID: ${{ secrets.AURA_CLIENT_ID }}
          AURA_CLIENT_SECRET: ${{ secrets.AURA_CLIENT_SECRET }}
        run: |
          aura-cli credential add \
            --name "ci" \
            --client-id "$AURA_CLIENT_ID" \
            --client-secret "$AURA_CLIENT_SECRET"

      - name: Validate Neo4j Aura Credentials (Aura CLI)
        id: neo4j-check
        run: |
          if aura-cli instance list --output json >/dev/null 2>&1; then
            echo "✅ Neo4j Aura credentials are valid (Aura CLI)"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Neo4j Aura CLI authentication failed"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Cleanup Aura CLI config
        if: always()
        run: |
          rm -rf "$XDG_CONFIG_HOME"

  validate-neo4j-connector:
    name: Validate Neo4j Spark Connector
    runs-on: ubuntu-latest
    needs: validate-credentials
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Neo4j Connector Version
        run: |
          echo "Validating Neo4j Spark Connector 5.3.0 for Spark 3.5"
          
          # Check if connector library exists in configs
          if [ -f "configs/neo4j-connector-config.yml" ]; then
            echo "✅ Neo4j connector configuration found"
          else
            echo "⚠️ Neo4j connector configuration not found - will be created"
          fi
          
          echo "Target Connector: neo4j-connector-apache-spark_2.12:5.3.0_for_spark_3.5"
          echo "Maven Repository: https://repo1.maven.org/maven2/"

      - name: Validate Connector Compatibility
        run: |
          cat > /tmp/connector-check.py << 'EOF'
          import requests
          import sys
          
          # Check if Neo4j connector exists in Maven Central
          connector_version = "5.3.0_for_spark_3.5"
          group_id = "org.neo4j"
          artifact_id = "neo4j-connector-apache-spark_2.12"
          
          maven_url = f"https://repo1.maven.org/maven2/org/neo4j/{artifact_id}/{connector_version}/"
          
          response = requests.get(maven_url)
          if response.status_code == 200:
              print(f"✅ Neo4j Connector {connector_version} is available in Maven Central")
              sys.exit(0)
          else:
              print(f"❌ Neo4j Connector {connector_version} not found in Maven Central")
              print(f"URL checked: {maven_url}")
              sys.exit(1)
          EOF
          
          python /tmp/connector-check.py

  validate-region-configuration:
    name: Validate UK South Region Configuration
    runs-on: ubuntu-latest
    needs: validate-credentials
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Azure UK South Region
        run: |
          echo "Validating UK South region configuration"
          
          # Check if terraform configs use UK South
          if grep -r "uksouth" terraform/; then
            echo "✅ UK South region configured in Terraform"
          else
            echo "⚠️ UK South region not found in Terraform configs"
          fi

      - name: Validate Neo4j UK Region
        run: |
          echo "Neo4j Aura UK South region: uksouth"
          echo "✅ UK region configured for data residency compliance"

  summary:
    name: Prerequisites Summary
    runs-on: ubuntu-latest
    needs: [validate-credentials, validate-neo4j-connector, validate-region-configuration]
    steps:
      - name: Prerequisites Summary
        run: |
          echo "=================================="
          echo "Prerequisites Validation Complete"
          echo "=================================="
          echo ""
          echo "✅ Azure Credentials: Valid"
          echo "✅ Databricks Token: Valid"
          echo "✅ Neo4j Aura Credentials: Valid"
          echo "✅ Neo4j Spark Connector: Compatible"
          echo "✅ UK South Region: Configured"
          echo ""
          echo "Ready to proceed with infrastructure deployment!"
