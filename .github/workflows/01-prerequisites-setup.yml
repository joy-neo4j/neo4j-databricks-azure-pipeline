name: 01 - Prerequisites Setup

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: prereqs-${{ github.ref }}-dev
  cancel-in-progress: true

jobs:
  validate-credentials:
    name: Validate Azure and Neo4j Credentials
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      azure_valid: ${{ steps.azure-check.outputs.valid }}
      databricks_valid: ${{ steps.databricks-check.outputs.valid }}
      neo4j_valid: ${{ steps.neo4j-check.outputs.valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install azure-cli databricks-cli requests pyyaml

      - name: Azure login (validate AZURE_CREDENTIALS)
        id: azure-login
        uses: azure/login@v2
        continue-on-error: true
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure validity output
        id: azure-check
        run: |
          if [ "${{ steps.azure-login.outcome }}" == "success" ]; then
            echo "✅ Azure credentials are valid"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Azure credentials are invalid or not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Databricks Token
        id: databricks-check
        run: |
          if [ -n "${{ secrets.DATABRICKS_TOKEN }}" ]; then
            echo "✅ Databricks token is configured"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Databricks token not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Validate Neo4j Aura Credentials
        id: neo4j-check
        run: |
          if [ -n "${{ secrets.AURA_CLIENT_ID }}" ] && [ -n "${{ secrets.AURA_CLIENT_SECRET }}" ]; then
            set -e

            curl_json() {
              # Emits: " HTTPSTATUS:<code>"
              curl -sS -m 20 --retry 2 -w ' HTTPSTATUS:%{http_code}' "$@"
            }

            get_token() {
              local audience="$1"
              curl_json \
                -H "Content-Type: application/x-www-form-urlencoded" \
                --data-urlencode grant_type=client_credentials \
                --data-urlencode audience="$audience" \
                --data-urlencode client_id="${{ secrets.AURA_CLIENT_ID }}" \
                --data-urlencode client_secret="${{ secrets.AURA_CLIENT_SECRET }}" \
                https://api.neo4j.io/oauth/token
            }

            # Try audience with trailing slash first, then without
            RESP="$(get_token 'https://api.neo4j.io/')"
            CODE="${RESP##*HTTPSTATUS:}"
            BODY="${RESP% HTTPSTATUS:*}"
            if [ "$CODE" -ne 200 ]; then
              echo "First token attempt failed (HTTP $CODE)"
              echo "error=$(echo "$BODY" | jq -r '.error // empty' 2>/dev/null)"
              echo "desc=$(echo "$BODY" | jq -r '.error_description // empty' 2>/dev/null)"
              RESP="$(get_token 'https://api.neo4j.io')"
              CODE="${RESP##*HTTPSTATUS:}"
              BODY="${RESP% HTTPSTATUS:*}"
            fi

            if [ "$CODE" -ne 200 ]; then
              echo "❌ Neo4j Aura OAuth token request failed (HTTP $CODE)"
              echo "error=$(echo "$BODY" | jq -r '.error // empty' 2>/dev/null)"
              echo "desc=$(echo "$BODY" | jq -r '.error_description // empty' 2>/dev/null)"
              echo "valid=false" >> $GITHUB_OUTPUT
              exit 1
            fi

            ACCESS_TOKEN="$(echo "$BODY" | jq -r '.access_token // empty' 2>/dev/null || python -c "import sys,json; print(json.loads(sys.stdin.read()).get('access_token',''))" <<<"$BODY")"
            if [ -z "$ACCESS_TOKEN" ]; then
              echo "❌ access_token not found in token response"
              echo "valid=false" >> $GITHUB_OUTPUT
              exit 1
            fi

            # Optional: reachability/permissions check (non-200 does not fail credentials)
            INST_RESP="$(curl_json -H "Authorization: Bearer $ACCESS_TOKEN" https://api.neo4j.io/v1/instances)"
            INST_CODE="${INST_RESP##*HTTPSTATUS:}"
            INST_BODY="${INST_RESP% HTTPSTATUS:*}"

            if [ "$INST_CODE" -eq 200 ]; then
              echo "✅ Neo4j Aura credentials are valid and API reachable"
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "⚠️ Token valid; instances call returned HTTP $INST_CODE"
              echo "valid=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ Neo4j Aura credentials not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  validate-neo4j-connector:
    name: Validate Neo4j Spark Connector
    runs-on: ubuntu-latest
    needs: validate-credentials
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Neo4j Connector Version
        run: |
          echo "Validating Neo4j Spark Connector 5.3.0 for Spark 3.5"
          
          # Check if connector library exists in configs
          if [ -f "configs/neo4j-connector-config.yml" ]; then
            echo "✅ Neo4j connector configuration found"
          else
            echo "⚠️ Neo4j connector configuration not found - will be created"
          fi
          
          echo "Target Connector: neo4j-connector-apache-spark_2.12:5.3.0_for_spark_3.5"
          echo "Maven Repository: https://repo1.maven.org/maven2/"

      - name: Validate Connector Compatibility
        run: |
          cat > /tmp/connector-check.py << 'EOF'
          import requests
          import sys
          
          # Check if Neo4j connector exists in Maven Central
          connector_version = "5.3.0_for_spark_3.5"
          group_id = "org.neo4j"
          artifact_id = "neo4j-connector-apache-spark_2.12"
          
          maven_url = f"https://repo1.maven.org/maven2/org/neo4j/{artifact_id}/{connector_version}/"
          
          response = requests.get(maven_url)
          if response.status_code == 200:
              print(f"✅ Neo4j Connector {connector_version} is available in Maven Central")
              sys.exit(0)
          else:
              print(f"❌ Neo4j Connector {connector_version} not found in Maven Central")
              print(f"URL checked: {maven_url}")
              sys.exit(1)
          EOF
          
          python /tmp/connector-check.py

  validate-region-configuration:
    name: Validate UK South Region Configuration
    runs-on: ubuntu-latest
    needs: validate-credentials
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Azure UK South Region
        run: |
          echo "Validating UK South region configuration"
          
          # Check if terraform configs use UK South
          if grep -r "uksouth" terraform/; then
            echo "✅ UK South region configured in Terraform"
          else
            echo "⚠️ UK South region not found in Terraform configs"
          fi

      - name: Validate Neo4j UK Region
        run: |
          echo "Neo4j Aura UK South region: uksouth"
          echo "✅ UK region configured for data residency compliance"

  summary:
    name: Prerequisites Summary
    runs-on: ubuntu-latest
    needs: [validate-credentials, validate-neo4j-connector, validate-region-configuration]
    steps:
      - name: Prerequisites Summary
        run: |
          echo "=================================="
          echo "Prerequisites Validation Complete"
          echo "=================================="
          echo ""
          echo "✅ Azure Credentials: Valid"
          echo "✅ Databricks Token: Valid"
          echo "✅ Neo4j Aura Credentials: Valid"
          echo "✅ Neo4j Spark Connector: Compatible"
          echo "✅ UK South Region: Configured"
          echo ""
          echo "Ready to proceed with infrastructure deployment!"
