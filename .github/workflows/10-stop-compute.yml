name: Stop Compute

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'What to stop/cleanup'
        required: true
        type: choice
        options:
          - stop-dbx-clusters
          - stop-aura
          - cleanup-temp
      confirm:
        description: 'Type CONFIRM to proceed'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: stop-compute-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "CONFIRM" ]; then
            echo "::error::Confirmation not provided. Type CONFIRM to proceed."
            exit 1
          fi
          echo "✅ Confirmation validated"

  stop-dbx-clusters:
    if: ${{ inputs.action == 'stop-dbx-clusters' }}
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Install Databricks CLI (Go)
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          echo "$HOME/.databricks/bin" >> $GITHUB_PATH
      - name: Export Databricks env
        run: |
          echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST }}" >> $GITHUB_ENV
          echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN }}" >> $GITHUB_ENV
      - name: Stop all running clusters (fail if none)
        run: |
          set -euo pipefail
          ids=$(databricks clusters list --output json | jq -r '.clusters[] | select(.state=="RUNNING") | .cluster_id')
          if [ -z "$ids" ]; then
            echo "::error::No running clusters found"
            exit 1
          fi
          while read -r cid; do
            [ -z "$cid" ] && continue
            echo "Stopping cluster: ${cid}"
            databricks clusters delete --cluster-id "${cid}"
          done <<< "$ids"
          echo "✅ Stop request(s) sent"

  stop-aura:
    if: ${{ inputs.action == 'stop-aura' }}
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Pause Aura instance (do not fail if not found or already paused)
        env:
          AURA_CLIENT_ID: ${{ secrets.AURA_CLIENT_ID }}
          AURA_CLIENT_SECRET: ${{ secrets.AURA_CLIENT_SECRET }}
          AURA_INSTANCE_ID: ${{ secrets.AURA_INSTANCE_ID }}
          AURA_TENANT_ID: ${{ secrets.AURA_TENANT_ID }}
        run: |
          set -euo pipefail
          if [ -z "${AURA_CLIENT_ID:-}" ] || [ -z "${AURA_CLIENT_SECRET:-}" ] || [ -z "${AURA_INSTANCE_ID:-}" ]; then
            echo "::error::Aura credentials or instance ID not provided; failing"
            exit 1
          fi

          echo "Checking Aura instance ${AURA_INSTANCE_ID} state"
          get_code=$(curl -sS -u "$AURA_CLIENT_ID:$AURA_CLIENT_SECRET" \
            "https://api.neo4j.io/v1/instances/${AURA_INSTANCE_ID}" \
            -H 'Accept: application/json' -o /tmp/aura_get.json -w "%{http_code}")
          echo "GET /instances/${AURA_INSTANCE_ID} code: $get_code"

          # Tenant-aware fallback for GET if 403 or 404 and AURA_TENANT_ID is provided
          if [ "$get_code" -eq 403 ] || [ "$get_code" -eq 404 ]; then
            if [ -n "${AURA_TENANT_ID:-}" ]; then
              echo "Retrying with tenant-aware endpoint: /tenants/${AURA_TENANT_ID}/instances/${AURA_INSTANCE_ID}"
              get_code=$(curl -sS -u "$AURA_CLIENT_ID:$AURA_CLIENT_SECRET" \
                "https://api.neo4j.io/v1/tenants/${AURA_TENANT_ID}/instances/${AURA_INSTANCE_ID}" \
                -H 'Accept: application/json' -o /tmp/aura_get.json -w "%{http_code}")
              echo "GET /tenants/${AURA_TENANT_ID}/instances/${AURA_INSTANCE_ID} code: $get_code"
            fi
          fi

          if [ "$get_code" -eq 404 ]; then
            echo "::warning::Aura instance not found; skipping"
            exit 0
          elif [ "$get_code" -lt 200 ] || [ "$get_code" -ge 300 ]; then
            echo "::error::Failed to query Aura instance (HTTP $get_code)"
            sed 's/^/    /' /tmp/aura_get.json || true
            exit 1
          fi

          state=$(python3 - << 'PY'
          import json
          try:
            d=json.load(open("/tmp/aura_get.json"))
            print((d.get("state") or d.get("status") or "").lower())
          except Exception:
            print("")
          PY
          )
          if [ "$state" = "paused" ]; then
            echo "::warning::Aura instance is already paused; skipping"
            exit 0
          fi

          echo "Attempting to pause Aura instance ${AURA_INSTANCE_ID}"
          post_code=$(curl -sS -u "$AURA_CLIENT_ID:$AURA_CLIENT_SECRET" -X POST \
            "https://api.neo4j.io/v1/instances/${AURA_INSTANCE_ID}/pause" \
            -H 'Content-Type: application/json' -d '{}' -o /tmp/aura_pause.json -w "%{http_code}")
          echo "POST /instances/${AURA_INSTANCE_ID}/pause code: $post_code"

          # Tenant-aware fallback for POST if 403 or 404 and AURA_TENANT_ID is provided
          if [ "$post_code" -eq 403 ] || [ "$post_code" -eq 404 ]; then
            if [ -n "${AURA_TENANT_ID:-}" ]; then
              echo "Retrying with tenant-aware endpoint: /tenants/${AURA_TENANT_ID}/instances/${AURA_INSTANCE_ID}/pause"
              post_code=$(curl -sS -u "$AURA_CLIENT_ID:$AURA_CLIENT_SECRET" -X POST \
                "https://api.neo4j.io/v1/tenants/${AURA_TENANT_ID}/instances/${AURA_INSTANCE_ID}/pause" \
                -H 'Content-Type: application/json' -d '{}' -o /tmp/aura_pause.json -w "%{http_code}")
              echo "POST /tenants/${AURA_TENANT_ID}/instances/${AURA_INSTANCE_ID}/pause code: $post_code"
            fi
          fi

          if [ "$post_code" -eq 409 ]; then
            echo "::warning::Aura instance already paused; skipping"
            exit 0
          elif [ "$post_code" -lt 200 ] || [ "$post_code" -ge 300 ]; then
            echo "::error::Aura pause failed (HTTP $post_code)"
            sed 's/^/    /' /tmp/aura_pause.json || true
            exit 1
          fi

          echo "✅ Aura pause request accepted"
          sleep 2
          echo "Stop Compute (Aura) completed"

  cleanup-temp:
    if: ${{ inputs.action == 'cleanup-temp' }}
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run stop-compute script (cleanup-temp)
        run: |
          bash scripts/stop-compute.sh cleanup-temp
