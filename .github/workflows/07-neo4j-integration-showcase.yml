name: 07 - Neo4j Integration Showcase (Single Environment)

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: showcase-${{ github.ref }}
  cancel-in-progress: true

jobs:
  execute-pipeline:
    name: Execute Complete E-commerce Pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install databricks-cli databricks-sdk neo4j

      - name: Configure Databricks
        env:
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          cat > ~/.databrickscfg << EOF
          [DEFAULT]
          host = ${{ secrets.DATABRICKS_HOST }}
          token = $DATABRICKS_TOKEN
          EOF

      - name: Run E-commerce Data Ingestion
        run: |
          cat > /tmp/run-ingestion.py << 'EOF'
          from databricks.sdk import WorkspaceClient
          import time
          w = WorkspaceClient()
          jobs = list(w.jobs.list(name="E-commerce Data Ingestion - dev"))
          if jobs:
              job = jobs[0]
              print(f"Running ingestion job: {job.settings.name}")
              run = w.jobs.run_now(job_id=job.job_id)
              print(f"Job run started: {run.run_id}")
              while True:
                  run_status = w.jobs.get_run(run.run_id)
                  state = run_status.state.life_cycle_state
                  print(f"Status: {state}")
                  if state in ["TERMINATED", "SKIPPED", "INTERNAL_ERROR"]:
                      if run_status.state.result_state == "SUCCESS":
                          print("✅ Ingestion completed successfully")
                          break
                      else:
                          print(f"❌ Ingestion failed: {run_status.state.result_state}")
                          exit(1)
                  time.sleep(30)
          else:
              print("Ingestion job not found, will be created")
          EOF
          python /tmp/run-ingestion.py || echo "Ingestion job will run manually"

      - name: Run Graph Transformation and Neo4j Loading
        run: |
          cat > /tmp/run-neo4j-loading.py << 'EOF'
          from databricks.sdk import WorkspaceClient
          import time
          w = WorkspaceClient()
          jobs = list(w.jobs.list(name="Neo4j Graph Loading - dev"))
          if jobs:
              job = jobs[0]
              print(f"Running Neo4j loading job: {job.settings.name}")
              run = w.jobs.run_now(job_id=job.job_id)
              print(f"Job run started: {run.run_id}")
              while True:
                  run_status = w.jobs.get_run(run.run_id)
                  state = run_status.state.life_cycle_state
                  print(f"Status: {state}")
                  if state in ["TERMINATED", "SKIPPED", "INTERNAL_ERROR"]:
                      if run_status.state.result_state == "SUCCESS":
                          print("✅ Neo4j loading completed successfully")
                          break
                      else:
                          print(f"❌ Neo4j loading failed: {run_status.state.result_state}")
                          exit(1)
                  time.sleep(30)
          else:
              print("Neo4j loading job not found")
          EOF
          python /tmp/run-neo4j-loading.py || echo "Neo4j loading job will run manually"

  verify-graph-data:
    name: Verify Neo4j Graph Data
    runs-on: ubuntu-latest
    needs: execute-pipeline
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Neo4j driver
        run: |
          pip install neo4j

      - name: Verify Graph Structure
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USERNAME }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        run: |
          cat > /tmp/verify-graph.py << 'EOF'
          from neo4j import GraphDatabase
          import os, sys
          uri = os.environ['NEO4J_URI']; user = os.environ['NEO4J_USER']; password = os.environ['NEO4J_PASSWORD']
          try:
              driver = GraphDatabase.driver(uri, auth=(user, password))
              with driver.session() as session:
                  result = session.run("RETURN 1 as test"); assert result.single()["test"] == 1
                  print("✅ Neo4j connection successful")
              driver.close()
          except Exception as e:
              print(f"❌ Failed to verify graph: {str(e)}"); sys.exit(1)
          EOF
          python /tmp/verify-graph.py


